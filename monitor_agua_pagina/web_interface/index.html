<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de la Calidad del Agua - ESP32</title>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1> Monitoreo de la Calidad del Agua</h1>
            <div class="status-bar">
                <div id="connection-status" class="status-item">
                    <span class="status-dot offline"></span>
                    <span>ESP32 Desconectado</span>
                </div>
                <div id="last-update" class="status-item">
                    √öltima actualizaci√≥n: --:--:--
                </div>
                <div id="esp32-health" class="status-item">
                    üíä Salud ESP32: --%
                </div>
            </div>
            
            <!-- Informaci√≥n RTC -->
            <div class="rtc-info">
                <strong>üïê RTC:</strong>
                <span id="rtc-status">Estado desconocido</span>
            </div>
            
            <!-- Bot√≥n de descarga -->
            <div class="download-section">
                <button id="download-btn" class="download-button" disabled>
                    üì• Descargar Datos del ESP32
                </button>
                <div id="download-status" class="download-status"></div>
            </div>
        </header>

        <!-- Alertas -->
        <div id="alerts-container" class="alerts-container hidden">
            <h3>‚ö†Ô∏è Alertas Activas</h3>
            <div id="alerts-list"></div>
        </div>

        <!-- Valores Actuales -->
        <section class="current-values">
            <div class="values-container">
                <h2> Valores Actuales</h2>
                <div class="values-grid">
                    <div class="value-card temperature">
                        <div class="value-icon">üå°Ô∏è</div>
                        <div class="value-info">
                            <div class="value-label">Temperatura</div>
                            <div id="temp-value" class="value-number">--.-¬∞C</div>
                            <div id="temp-status" class="value-status">-</div>
                        </div>
                    </div>
                    
                    <div class="value-card ph">
                        <div class="value-icon">üß™</div>
                        <div class="value-info">
                            <div class="value-label">pH</div>
                            <div id="ph-value" class="value-number">-.--</div>
                            <div id="ph-status" class="value-status">-</div>
                        </div>
                    </div>
                    
                    <div class="value-card turbidity">
                        <div class="value-icon">üå´Ô∏è</div>
                        <div class="value-info">
                            <div class="value-label">Turbidez</div>
                            <div id="turbidity-value" class="value-number">-.- NTU</div>
                            <div id="turbidity-status" class="value-status">-</div>
                        </div>
                    </div>
                    
                    <div class="value-card tds">
                        <div class="value-icon">üíß</div>
                        <div class="value-info">
                            <div class="value-label">TDS</div>
                            <div id="tds-value" class="value-number">--- ppm</div>
                            <div id="tds-status" class="value-status">-</div>
                        </div>
                    </div>
                    
                    <div class="value-card ec">
                        <div class="value-icon">‚ö°</div>
                        <div class="value-info">
                            <div class="value-label">Conductividad El√©ctrica</div>
                            <div id="ec-value" class="value-number">--- ¬µS/cm</div>
                            <div id="ec-status" class="value-status">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sistema de Pesta√±as para Sensores -->
        <section class="sensor-tabs-section">
            <h2>An√°lisis Detallado por Sensor</h2>
            
            <!-- Pesta√±as de navegaci√≥n -->
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="temperature">
                    <span class="tab-icon">üå°Ô∏è</span>
                    <span class="tab-label">Temperatura</span>
                </button>
                <button class="tab-button" data-tab="ph">
                    <span class="tab-icon">üß™</span>
                    <span class="tab-label">pH</span>
                </button>
                <button class="tab-button" data-tab="turbidity">
                    <span class="tab-icon">üå´Ô∏è</span>
                    <span class="tab-label">Turbidez</span>
                </button>
                <button class="tab-button" data-tab="tds">
                    <span class="tab-icon">üíß</span>
                    <span class="tab-label">TDS</span>
                </button>
                <button class="tab-button" data-tab="complete-history">
                    <span class="tab-icon">üìã</span>
                    <span class="tab-label">Historial Completo</span>
                </button>
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AGREGAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <button class="tab-button" data-tab="calibration">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span class="tab-label">Calibraci√≥n</span>
                </button>
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIN NUEVO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            </div>

            <!-- Contenido de las pesta√±as -->
            <div class="tabs-content">
                <!-- Pesta√±a Temperatura -->
                <div id="tab-temperature" class="tab-panel active">
                    <div class="sensor-header">
                        <h3>üå°Ô∏è An√°lisis de Temperatura</h3>
                        <div class="sensor-summary">
                            <div class="summary-item">
                                <span class="summary-label">√öltimo valor:</span>
                                <span id="temperature-last-value" class="summary-value">--.-¬∞C</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio:</span>
                                <span id="temperature-average" class="summary-value">--.-¬∞C</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">M√≠n/M√°x:</span>
                                <span id="temperature-range" class="summary-value">--.- / --.-¬∞C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-content">
                        <!-- Gr√°fico grande -->
                        <div class="large-chart-container">
                            <canvas id="tempChartLarge"></canvas>
                        </div>
                        
                        <!-- Tabla de datos espec√≠ficos -->
                        <div class="sensor-data-table">
                            <h4> Historial de Temperatura</h4>
                            <div class="table-container">
                                <table id="temperature-data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora RTC</th>
                                            <th>Temperatura (¬∞C)</th>
                                            <th>Estado</th>
                                            <th>Lectura #</th>
                                        </tr>
                                    </thead>
                                    <tbody id="temperature-data-body">
                                        <tr>
                                            <td colspan="4" class="no-data">
                                                Presiona "Descargar Datos del ESP32" para ver el historial
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a pH -->
                <div id="tab-ph" class="tab-panel">
                    <div class="sensor-header">
                        <h3>üß™ An√°lisis de pH</h3>
                        <div class="sensor-summary">
                            <div class="summary-item">
                                <span class="summary-label">√öltimo valor:</span>
                                <span id="ph-last-value" class="summary-value">-.--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio:</span>
                                <span id="ph-average" class="summary-value">-.--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">M√≠n/M√°x:</span>
                                <span id="ph-range" class="summary-value">-.-- / -.--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-content">
                        <div class="large-chart-container">
                            <canvas id="phChartLarge"></canvas>
                        </div>
                        
                        <div class="sensor-data-table">
                            <h4> Historial de pH</h4>
                            <div class="table-container">
                                <table id="ph-data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora RTC</th>
                                            <th>pH</th>
                                            <th>Estado</th>
                                            <th>Lectura #</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ph-data-body">
                                        <tr>
                                            <td colspan="4" class="no-data">
                                                Presiona "Descargar Datos del ESP32" para ver el historial
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Turbidez -->
                <div id="tab-turbidity" class="tab-panel">
                    <div class="sensor-header">
                        <h3>üå´Ô∏è An√°lisis de Turbidez</h3>
                        <div class="sensor-summary">
                            <div class="summary-item">
                                <span class="summary-label">√öltimo valor:</span>
                                <span id="turbidity-last-value" class="summary-value">-.- NTU</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio:</span>
                                <span id="turbidity-average" class="summary-value">-.- NTU</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">M√≠n/M√°x:</span>
                                <span id="turbidity-range" class="summary-value">-.- / -.- NTU</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-content">
                        <div class="large-chart-container">
                            <canvas id="turbidityChartLarge"></canvas>
                        </div>
                        
                        <div class="sensor-data-table">
                            <h4> Historial de Turbidez</h4>
                            <div class="table-container">
                                <table id="turbidity-data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora RTC</th>
                                            <th>Turbidez (NTU)</th>
                                            <th>Estado</th>
                                            <th>Lectura #</th>
                                        </tr>
                                    </thead>
                                    <tbody id="turbidity-data-body">
                                        <tr>
                                            <td colspan="4" class="no-data">
                                                Presiona "Descargar Datos del ESP32" para ver el historial
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a TDS -->
                <div id="tab-tds" class="tab-panel">
                    <div class="sensor-header">
                        <h3>üíß An√°lisis de TDS y Conductividad El√©ctrica</h3>
                        
                        <!-- Selector de variable -->
                        <div class="variable-selector">
                            <label for="tds-variable-select">Mostrar variable:</label>
                            <select id="tds-variable-select" class="variable-select">
                                <option value="tds">TDS (ppm)</option>
                                <option value="ec">Conductividad El√©ctrica (¬µS/cm)</option>
                            </select>
                        </div>
                        
                        <div class="sensor-summary">
                            <div class="summary-item">
                                <span class="summary-label">√öltimo valor:</span>
                                <span id="tds-last-value" class="summary-value">--- ppm</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio:</span>
                                <span id="tds-average" class="summary-value">--- ppm</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">M√≠n/M√°x:</span>
                                <span id="tds-range" class="summary-value">--- / --- ppm</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sensor-content">
                        <div class="large-chart-container">
                            <canvas id="tdsChartLarge"></canvas>
                        </div>
                        
                        <div class="sensor-data-table">
                            <h4 id="tds-table-title"> Historial de TDS</h4>
                            <div class="table-container">
                                <table id="tds-data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora RTC</th>
                                            <th id="tds-table-header">TDS (ppm)</th>
                                            <th>Estado</th>
                                            <th>Lectura #</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tds-data-body">
                                        <tr>
                                            <td colspan="4" class="no-data">
                                                Presiona "Descargar Datos del ESP32" para ver el historial
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-complete-history" class="tab-panel">
                    <div class="sensor-header">
                        <h3>üìã Historial Completo de Lecturas</h3>
                        <div class="sensor-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total lecturas:</span>
                                <span id="history-total-readings" class="summary-value">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Primera lectura:</span>
                                <span id="history-first-reading" class="summary-value">--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">√öltima lectura:</span>
                                <span id="history-last-reading" class="summary-value">--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Estado ESP32:</span>
                                <span id="history-esp32-status" class="summary-value">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="complete-history-content">
                        <!-- Tabla completa -->
                        <div class="complete-history-table">
                            <div class="table-container">
                                <table id="complete-data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora RTC</th>
                                            <th>Hora Recepci√≥n</th>
                                            <th>Numero de lectura</th>
                                            <th>Temp (¬∞C)</th>
                                            <th> pH</th>
                                            <th> Turbidez (NTU)</th>
                                            <th> TDS (ppm)</th>
                                            <th> EC (¬µS/cm)</th>
                                            <th> RSSI</th>
                                            <th> Salud</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="complete-data-table-body">
                                        <tr>
                                            <td colspan="11" class="no-data">
                                                Presiona "Descargar Datos del ESP32" para obtener las lecturas
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PESTA√ëA DE CALIBRACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="tab-calibration" class="tab-panel">
                    <div class="sensor-header">
                        <h3>‚öôÔ∏è Calibraci√≥n de Sensores</h3>
                        <p style="color: #666; margin-top: 10px;">
                            Actualiza los valores de calibraci√≥n de los sensores de forma remota
                        </p>
                    </div>
                    
                    <!-- Grid de sensores -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
                        
                        <!-- Sensor pH -->
                        <div class="calibration-card">
                            <h4>üß™ Sensor de pH</h4>
                            
                            <div class="current-values-calib">
                                <div class="value-item">
                                    <span class="value-label">Offset actual:</span>
                                    <span class="value-number" id="calib-ph-offset-current">--</span>
                                </div>
                                <div class="value-item">
                                    <span class="value-label">Slope actual:</span>
                                    <span class="value-number" id="calib-ph-slope-current">--</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Offset de Calibraci√≥n</label>
                                <input type="number" id="calib-ph-offset" step="0.01" placeholder="Ej: 1.33">
                                <small>Rango: -5.0 a +5.0</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Pendiente (Slope)</label>
                                <input type="number" id="calib-ph-slope" step="0.01" placeholder="Ej: 3.5">
                                <small>Rango: -10.0 a +10.0</small>
                            </div>
                            
                            <button class="btn-primary" onclick="monitor.calibratePH()">
                                Aplicar pH
                            </button>
                        </div>
                        
                        <!-- Sensor TDS -->
                        <div class="calibration-card">
                            <h4>üíß Sensor TDS</h4>
                            
                            <div class="current-values-calib">
                                <div class="value-item">
                                    <span class="value-label">K-Value actual:</span>
                                    <span class="value-number" id="calib-tds-kvalue-current">--</span>
                                </div>
                                <div class="value-item">
                                    <span class="value-label">V-Offset actual:</span>
                                    <span class="value-number" id="calib-tds-voffset-current">--</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Factor K</label>
                                <input type="number" id="calib-tds-kvalue" step="0.01" placeholder="Ej: 1.60">
                                <small>Rango: 0.1 a 5.0</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Offset de Voltaje</label>
                                <input type="number" id="calib-tds-voffset" step="0.00001" placeholder="Ej: 0.10000">
                                <small>Rango: -1.0 a +1.0</small>
                            </div>
                            
                            <button class="btn-primary" onclick="monitor.calibrateTDS()">
                                Aplicar TDS
                            </button>
                        </div>
                        
                        <!-- Sensor Turbidez -->
                        <div class="calibration-card">
                            <h4>üå´Ô∏è Sensor de Turbidez</h4>
                            
                            <div class="current-values-calib">
                                <div class="value-item">
                                    <span class="value-label">Coef. A:</span>
                                    <span class="value-number" id="calib-turb-a-current">--</span>
                                </div>
                                <div class="value-item">
                                    <span class="value-label">Coef. B:</span>
                                    <span class="value-number" id="calib-turb-b-current">--</span>
                                </div>
                                <div class="value-item">
                                    <span class="value-label">Coef. C:</span>
                                    <span class="value-number" id="calib-turb-c-current">--</span>
                                </div>
                                <div class="value-item">
                                    <span class="value-label">Coef. D:</span>
                                    <span class="value-number" id="calib-turb-d-current">--</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Coeficiente A (c√∫bico)</label>
                                <input type="number" id="calib-turb-a" step="0.1" placeholder="-1120.4">
                            </div>
                            
                            <div class="form-group">
                                <label>Coeficiente B (cuadr√°tico)</label>
                                <input type="number" id="calib-turb-b" step="0.1" placeholder="5742.3">
                            </div>
                            
                            <div class="form-group">
                                <label>Coeficiente C (lineal)</label>
                                <input type="number" id="calib-turb-c" step="0.1" placeholder="-4352.9">
                            </div>
                            
                            <div class="form-group">
                                <label>Coeficiente D (independiente)</label>
                                <input type="number" id="calib-turb-d" step="0.1" placeholder="-2500.0">
                            </div>
                            
                            <button class="btn-primary" onclick="monitor.calibrateTurbidity()">
                                Aplicar Turbidez
                            </button>
                        </div>
                    </div>
                    
                    <!-- Acciones globales -->
                    <div class="calibration-actions">
                        <button class="btn-primary" onclick="monitor.requestCurrentCalibration()">
                            üìä Obtener Valores Actuales
                        </button>
                        <button class="btn-danger" onclick="monitor.restoreDefaultsCalibration()">
                            üîÑ Restaurar Valores por Defecto
                        </button>
                    </div>
                    
                    <!-- Metadata -->
                    <div class="calibration-metadata">
                        <h4>üìã Informaci√≥n del Sistema</h4>
                        <div class="value-item">
                            <span class="value-label">√öltima actualizaci√≥n:</span>
                            <span class="value-number" id="calib-last-update">--</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label">N√∫mero de actualizaciones:</span>
                            <span class="value-number" id="calib-update-count">--</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label">CRC:</span>
                            <span class="value-number" id="calib-crc">--</span>
                        </div>
                    </div>
                    
                    <!-- Log de calibraci√≥n -->
                    <div class="calibration-log">
                        <h4>üìù Registro de Calibraci√≥n</h4>
                        <div class="log-content" id="calibration-log-content">
                            <div class="log-entry log-info">
                                <span class="log-time">[Inicio]</span> Sistema de calibraci√≥n listo
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIN PESTA√ëA CALIBRACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            </div>
        </section>



        <!-- Informaci√≥n del Sistema -->
        <section class="system-info">
            <h2> Informaci√≥n del Sistema</h2>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Total lecturas:</strong>
                    <span id="total-readings">0</span>
                </div>
                <div class="info-item">
                    <strong>Estado ESP32:</strong>
                    <span id="esp32-status">Desconectado</span>
                </div>
                <div class="info-item">
                    <strong>Memoria libre ESP32:</strong>
                    <span id="esp32-memory">--- bytes</span>
                </div>
                <div class="info-item">
                    <strong>Servidor iniciado:</strong>
                    <span id="server-start-time">--:--:--</span>
                </div>
            </div>
        </section>
    </div>

    <!-- JavaScript personalizado -->
    <script src="js/script.js"></script>

    <div id="sidebar-menu" class="sidebar-menu">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <h3> Historial de Pruebas</h3>
                <p class="sidebar-subtitle">Gesti√≥n de sesiones</p>
            </div>
            <button id="sidebar-close" class="sidebar-close">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="sessions-list">
                <div class="sessions-header">
                    <h4>üìà Sesiones de Medici√≥n</h4>
                    <div class="sessions-stats">
                        <span>Sesiones guardadas</span>
                    </div>
                </div>
                
                <div id="sessions-container">
                    <div class="no-sessions">
                        <div class="no-sessions-icon">üìä</div>
                        <div class="no-sessions-text">No hay sesiones guardadas</div>
                        <div class="no-sessions-hint">Las sesiones se guardan autom√°ticamente cuando el ESP32 se conecta</div>
                    </div>
                </div>
            </div>
            
            <div class="session-detail hidden" id="session-detail">
                <div class="session-detail-header">
                    <button id="back-to-sessions" class="back-button">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                        </svg>
                        Volver a sesiones
                    </button>
                    <div class="session-actions">
                        <button id="delete-session-btn" class="delete-session-button">
                            üóëÔ∏è Eliminar Sesi√≥n
                        </button>
                        <button id="export-session-btn" class="export-session-button">
                            üíæ Exportar Sesi√≥n
                        </button>
                    </div>
                </div>
                <div id="session-info"></div>
                <div id="session-data-table"></div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n para abrir men√∫ -->
    <button id="sidebar-toggle" class="sidebar-toggle">
        <div class="sidebar-toggle-content">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/>
            </svg>
            <span class="sidebar-toggle-text">Historial</span>
        </div>
    </button>
    
    <!-- Overlay para cerrar men√∫ -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>

    
</body>
</html>